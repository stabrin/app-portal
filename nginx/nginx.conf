server {
    listen 80;

    # --- ПРАВИЛА ДЛЯ СТАТИЧЕСКИХ ФАЙЛОВ ---
    # Порядок важен: сначала проверяем более конкретные пути.

    # Статика приложения DataMatrix
    # Перехватывает запросы вида: /datamatrix/static/style.css
    location /datamatrix/static/ {
        alias /app/datamatrix-static/;
        # Добавляем заголовки для кеширования статики в браузере на 7 дней
        expires 7d; 
        add_header Cache-Control "public";
    }

    # Статика нового приложения "Ручная агрегация" (на будущее)
    # Перехватывает запросы вида: /manual-aggregation/static/style.css
    location /manual-aggregation/static/ {
        alias /app/manual-aggregation-static/;
        expires 7d;
        add_header Cache-Control "public";
    }

    # Статика нового приложения "Интеграция ДМкод" (на будущее)
    # Перехватывает запросы вида: /dmkod/static/style.css
    location /dmkod/static/ {
        alias /app/dmkod-integration-static/;
        expires 7d;
        add_header Cache-Control "public";
    }

    # Статика главного портала
    # Перехватывает запросы вида: /static/css/style.css
    location /static/ {
        alias /app/portal-static/;
        expires 7d;
        add_header Cache-Control "public";
    }


    # --- ПРАВИЛА ДЛЯ ПРИЛОЖЕНИЙ (ПРОКСИРОВАНИЕ) ---
    # Порядок важен: от более конкретных URL к менее конкретным.

    # Правило для DataMatrix
    location /datamatrix/ {
        proxy_pass http://datamatrix-app:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Правило для "Ручной Агрегации"
    location /manual-aggregation/ {
        proxy_pass http://manual-aggregation-app:8001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }


    # Правило для ДМкод интеграции
    location /dmkod/ {
        proxy_pass http://dmkod-integration-app:8002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # --- НОВОЕ ПРАВИЛО ДЛЯ СЕРВИСА ГРАФИКОВ ---
    location /chart-api/ {
        # Важно: имя контейнера 'chart-api-prod' из вашего docker-compose.prod.yml
        proxy_pass http://chart-api-prod:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Увеличиваем таймауты, так как генерация графика может занять время
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Правило для главного портала (должно идти последним)
    location / {
        proxy_pass http://portal:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}