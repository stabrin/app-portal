{% extends "base.html" %}

{% block title %}Импорт кодов из ДМкод для заказа №{{ order.id }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">Импорт кодов из ДМкод</h1>
    <a href="{{ url_for('datamatrix_app.index') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Вернуться к списку заказов
    </a>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Заказ №{{ order.id }} - {{ order.client_name }}</h5>
    </div>
    <div class="card-body">
        {% if order.notes %}
            <p><strong>Комментарий к заказу:</strong> {{ order.notes }}</p>
        {% endif %}

        {# --- НОВАЯ ЛОГИКА ОТОБРАЖЕНИЯ --- #}
        {% if order.status == 'delta' %}
            <div class="alert alert-success" role="alert">
                <h4 class="alert-heading">Данные уже в системе</h4>
                <p>Этот заказ был обработан через интеграцию с "Дельта". Все коды маркировки и информация об упаковках уже загружены в систему.</p>
                <hr>
                <p class="mb-0">Вы можете перейти к <a href="{{ url_for('datamatrix_app.order_details', order_id=order.id) }}" class="alert-link">деталям заказа</a> для просмотра или формирования отчетов.</p>
            </div>
        {% elif not details_with_codes %}
            <div class="alert alert-warning" role="alert">
                <h4 class="alert-heading">Ожидание кодов</h4>
                <p>По данному заказу коды еще не получены из API ДМкод.</p>
                <hr>
                <p class="mb-0">Пожалуйста, вернитесь в приложение "ДМкод интеграция", выберите этот заказ и выполните действие "Скачать коды".</p>
            </div>
        {% else %} {# Этот блок теперь выполняется только для статуса 'dmkod' #}
            <p>Для этого заказа были получены коды маркировки. Вы можете загрузить их в систему для дальнейшей агрегации.</p>
            
            <table class="table table-bordered table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>GTIN</th>
                        <th>Количество кодов</th>
                        <th>Уровень агрегации</th>
                    </tr>
                </thead>
                <tbody>
                    {% for detail in details_with_codes %}
                    <tr>
                        <td><code>{{ detail.gtin }}</code></td>
                        <td>{{ detail.api_codes_json.codes|length }}</td>
                        <td>{{ detail.aggregation_level }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <hr class="my-4">
            <p>Агрегация будет выполнена автоматически на основе данных из "ДМкод".</p>
            <form method="POST" action="{{ url_for('datamatrix_app.order_details', order_id=order.id) }}">
                <input type="hidden" name="action" value="import_from_dmkod">
                <button type="submit" class="btn btn-primary btn-lg"><i class="bi bi-database-down"></i> Загрузить и агрегировать</button>
            </form>
        {% endif %}
    </div>
</div>
{% endblock %}