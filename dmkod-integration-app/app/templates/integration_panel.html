{% extends "dmkod_base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">Панель интеграции</h1>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Выбор заказа для операций</h5>
    </div>
    <div class="card-body">
        <p>Выберите заказ со статусом 'dmkod', чтобы активировать кнопки управления.</p>

        <!-- Форма для выбора заказа и выполнения действий -->
        <form method="POST" action="{{ url_for('dmkod_integration_app.integration_panel') }}">
            {{ form.hidden_tag() if form }} <!-- Для CSRF, если форма будет передана -->
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <!-- Шаг 1: Выбор заказа -->
            <div class="mb-4">
                <label for="order_id" class="form-label"><strong>Шаг 1: Выберите заказ</strong></label>
                <select class="form-select" name="order_id" id="order_id" onchange="this.form.submit()">
                    <option value="" {% if not selected_order_id %}selected{% endif %} disabled>--- Список заказов ---</option>
                    {% for order in orders %}
                        <option value="{{ order.id }}" {% if order.id == selected_order_id %}selected{% endif %}>
                            Заказ №{{ order.id }} - {{ order.client_name }} (от {{ order.created_at.strftime('%d.%m.%Y') }})
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Шаг 2: Кнопки действий (активны, если заказ выбран) -->
            {% if selected_order_id %}
            <div id="actions-panel">
                <label class="form-label"><strong>Шаг 2: Выполните действие для заказа №{{ selected_order_id }}</strong></label>
                <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                    {# 1. Активна, только если ID заказа в API еще не создан #}
                    <button type="submit" name="action" value="create_order" class="btn btn-primary" {% if selected_order.api_order_id %}disabled{% endif %}>
                        <i class="bi bi-plus-circle"></i> Создать заказ
                    </button>
                    {# 2. Активна, если ID заказа есть, а статус API еще пустой #}
                    <button type="submit" name="action" value="create_suborder_request" class="btn btn-info text-white" {% if not selected_order.api_order_id or selected_order.api_status %}disabled{% endif %}>
                        <i class="bi bi-node-plus"></i> Создать запрос
                    </button>
                    {# 3. Активна, только если статус 'Запрос создан' #}
                    <button type="submit" name="action" value="split_runs" class="btn btn-secondary" {% if selected_order.api_status != 'Запрос создан' %}disabled{% endif %}>
                        <i class="bi bi-layout-split"></i> Разбить на тиражи
                    </button>
                    {# 4. Активна, только если статус 'Тиражи созданы' #}
                    <button type="submit" name="action" value="prepare_json" class="btn btn-info text-white" {% if selected_order.api_status != 'Тиражи созданы' %}disabled{% endif %}>
                        <i class="bi bi-filetype-json"></i> Подготовить JSON
                    </button>
                    {# 5. Активна, если статус один из ['JSON заказан', 'Коды скачаны', 'Сведения подготовлены', 'Отчет подготовлен'] #}
                    <button type="submit" name="action" value="download_codes" class="btn btn-success" {% if selected_order.api_status not in ['JSON заказан', 'Коды скачаны', 'Сведения подготовлены', 'Отчет подготовлен'] %}disabled{% endif %}>
                        <i class="bi bi-download"></i> Скачать коды
                    </button>

                    {# --- НОВАЯ КНОПКА: ВЫГРУЗКА В ФОРМАТЕ ДЕЛЬТА --- #}
                    <button type="submit" name="action" value="export_delta" class="btn btn-info"
                            {% if not selected_order or (selected_order.api_status not in ['Коды скачаны', 'Сведения подготовлены', 'Отчет подготовлен'] and selected_order.status != 'delta') %}disabled{% endif %}
                            title="Выгрузить CSV-файл с кодами и сроком годности для системы 'Дельта'">
                        <i class="bi bi-filetype-csv"></i> Выгрузить в формате Дельта
                    </button>

                </div>
                <hr>
                <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                     {# 6. Активна, если статус 'JSON заказан' или 'Коды скачаны' #}
                     <button type="submit" name="action" value="prepare_report_data" class="btn btn-info text-white" {% if selected_order.api_status not in ['JSON заказан', 'Коды скачаны'] %}disabled{% endif %}>
                        <i class="bi bi-card-list"></i> Подготовить сведения
                    </button>
                    {# 7. Активна, только если статус 'Сведения подготовлены' #}
                    <button type="submit" name="action" value="prepare_report" class="btn btn-warning" {% if selected_order.api_status != 'Сведения подготовлены' %}disabled{% endif %}>
                        <i class="bi bi-file-earmark-text"></i> Подготовить отчет
                    </button>
                </div>
            </div>
            {% endif %}
        </form>
    </div>

    <!-- Блок для вывода ответа от API -->
    {% if api_response %}
    <div class="card-footer">
        <h5 class="mb-3">Ответ API</h5>
        <div>
            <p><strong>Статус ответа:</strong> 
                <span class="badge {% if api_response.status_code >= 200 and api_response.status_code < 300 %}bg-success{% else %}bg-danger{% endif %}">
                    {{ api_response.status_code }}
                </span>
            </p>
            <h6>Тело ответа:</h6>
            <pre><code class="text-break" style="font-size: 0.85rem;">{{ api_response.body }}</code></pre>
        </div>
        {# --- НОВЫЙ БЛОК: Вывод отладочного DataFrame --- #}
        {% if api_response.debug_details_df_output %}
        <div class="mt-3">
            <h6>Отладочный DataFrame (details_df):</h6>
            <pre><code class="text-break" style="font-size: 0.85rem;">{{ api_response.debug_details_df_output }}</code></pre>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}