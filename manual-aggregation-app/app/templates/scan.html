<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ручная Агрегация</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Стили для удобства работы со сканером */
        #scan-input:focus {
            caret-color: transparent; /* Скрываем курсор в поле ввода */
        }
        .status-bar {
            font-size: 1.2rem;
        }
        .items-list {
            max-height: 40vh;
            overflow-y: auto;
        }
        body {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- Заголовок страницы -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h4>Заказ №<span id="order-id">{{ order.id }}</span></h4>
                        <p class="text-muted mb-0">Клиент: <span id="client-name">{{ order.client_name }}</span></p>
                    </div>
                    <div>
                        <a href="{{ url_for('.logout_employee') }}" class="btn btn-outline-danger">Завершить смену</a>
                    </div>
                </div>

                <!-- Поле для сканирования -->
                <div class="card mb-3">
                    <div class="card-body">
                        <label for="scan-input" class="form-label h5">Сканирование</label>
                        <input type="text" id="scan-input" class="form-control form-control-lg" placeholder="Ожидание сканирования..." autocomplete="off" autofocus>
                    </div>
                </div>

                <!-- Область для сообщений от сервера -->
                <div id="message-area">
                    <!-- Сообщения (успех/ошибка) будут появляться здесь -->
                </div>

                <!-- Панель текущего состояния -->
                <div class="card">
                    <div class="card-header status-bar">
                        Текущий статус: <strong id="session-status">IDLE</strong>
                    </div>
                    <div class="card-body">
                        <h6 id="current-unit-title">Новая операция</h6>
                        <ul id="scanned-items-list" class="list-group items-list">
                            <li class="list-group-item text-muted">Отсканируйте первый товар...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- НАЧАЛО: НАДЕЖНАЯ ОБРАБОТКА ВВОДА СО СКАНЕРА ---

        const scanInput = document.getElementById('scan-input');
        
        // Элементы интерфейса для обновления
        const messageArea = document.getElementById('message-area');
        const sessionStatusEl = document.getElementById('session-status');
        const currentUnitTitleEl = document.getElementById('current-unit-title');
        const scannedItemsListEl = document.getElementById('scanned-items-list');

        let scanBuffer = '';
        let isAltSequence = false;
        let altCodeBuffer = '';

        // Умная фокусировка на поле ввода
        scanInput.focus();
        document.body.addEventListener('click', function(e) {
            if (!e.target.closest('a, button')) {
                scanInput.focus();
            }
        });

        // Основная функция отправки данных на сервер
        function sendScanToServer(code) {
            scanInput.placeholder = 'Обработка...';
            scanInput.disabled = true;

            fetch("{{ url_for('.process_scan') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}' // Для защиты, если используется Flask-WTF
                },
                body: JSON.stringify({ scanned_code: code })
            })
            .then(response => response.ok ? response.json() : Promise.reject(response))
            .then(data => {
                if (data.command === 'logout') {
                    window.location.href = "{{ url_for('.logout_employee') }}";
                    return;
                }
                updateUI(data);
            })
            .catch(error => {
                const errorData = {
                    status: 'error',
                    message: `Критическая ошибка: ${error.statusText || error.message}. Проверьте соединение.`,
                    session: null
                };
                updateUI(errorData);
            })
            .finally(() => {
                scanInput.placeholder = 'Ожидание сканирования...';
                scanInput.disabled = false;
                scanInput.focus();
            });
        }

        // Функция обновления интерфейса
        function updateUI(data) {
            messageArea.innerHTML = '';
            if (data.message) {
                const alertClass = data.status === 'error' ? 'alert-danger' : 'alert-success';
                messageArea.innerHTML = `<div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                                           ${data.message.replace(/\n/g, '<br>')}
                                           <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                         </div>`;
            }

            if (data.session) {
                const { status, payload } = data.session;
                sessionStatusEl.textContent = status || 'N/A';
                const { type, items } = payload.current_unit;
                currentUnitTitleEl.textContent = `Сборка '${type || 'операция'}'`;
                scannedItemsListEl.innerHTML = '';

                if (items && items.length > 0) {
                    items.forEach((item, index) => {
                        scannedItemsListEl.innerHTML += `<li class="list-group-item">${index + 1}. ${item}</li>`;
                    });
                } else {
                    scannedItemsListEl.innerHTML = '<li class="list-group-item text-muted">Отсканируйте первый товар...</li>';
                }
            } else {
                sessionStatusEl.textContent = 'ОШИБКА';
                currentUnitTitleEl.textContent = 'Состояние неизвестно';
                scannedItemsListEl.innerHTML = '<li class="list-group-item text-danger">Не удалось получить данные о сессии.</li>';
            }
        }

        // Обработчики событий клавиатуры для перехвата сканера
        scanInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                if (scanBuffer) {
                    sendScanToServer(scanBuffer);
                    scanBuffer = ''; isAltSequence = false; altCodeBuffer = ''; scanInput.value = '';
                }
                return;
            }
            if (event.key === 'Alt' && !isAltSequence) {
                isAltSequence = true; altCodeBuffer = ''; event.preventDefault(); return;
            }
            if (isAltSequence && event.code.startsWith('Numpad')) {
                altCodeBuffer += event.key; event.preventDefault(); return;
            }
            if (isAltSequence) { isAltSequence = false; altCodeBuffer = ''; }
            if (event.key === 'GroupSeparator' || event.keyCode === 29) {
                event.preventDefault(); scanBuffer += '\x1d';
            } else if (event.key.length === 1) {
                scanBuffer += event.key;
            }
        });

        scanInput.addEventListener('keyup', function(event) {
            if (event.key === 'Alt' && isAltSequence) {
                isAltSequence = false;
                if (altCodeBuffer) {
                    try {
                        const charCode = parseInt(altCodeBuffer, 10);
                        if (!isNaN(charCode) && charCode > 0) scanBuffer += String.fromCharCode(charCode);
                    } catch (e) { /* ignore */ }
                }
                altCodeBuffer = ''; event.preventDefault();
            }
        });
        // --- КОНЕЦ: НАДЕЖНАЯ ОБРАБОТКА ВВОДА СО СКАНЕРА ---
    });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>