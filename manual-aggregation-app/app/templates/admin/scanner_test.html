{% extends "admin/base_admin.html" %}

{% block title %}Тестирование сканера{% endblock %}

{% block content %}
<style>
    #char-analysis-table td, #char-analysis-table th {
        font-family: monospace;
        padding: 0.4rem;
    }
    .gs-found {
        background-color: #d1e7dd !important;
        font-weight: bold;
    }
    .barcode-instruction {
        background-color: #fff;
        border: 1px solid #dee2e6;
        padding: 15px;
        border-radius: 5px;
    }
    .barcode-instruction img {
        display: block;
        margin: 0 auto;
        max-width: 250px;
        border: 1px solid #ccc;
    }
    /* Позволяет скрыть стандартный курсор в поле ввода, т.к. используется сканер */
    #scan-input:focus {
        caret-color: transparent;
    }
</style>

<div class="container-fluid mt-3">
    <h1 class="mb-4">Тестирование и настройка сканера</h1>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Инструкция</h5>
                </div>
                <div class="card-body">
                    <p>Эта страница поможет вам проверить, правильно ли ваш сканер (например, Zebra DS2208) передает коды DataMatrix в систему.</p>
                    <ol>
                        <li><strong>Цель:</strong> Убедиться, что сканер передает разделитель групп, который система сможет распознать. Чаще всего браузеры преобразуют невидимый символ <strong>GS (Group Separator)</strong> в обычный пробел.</li>
                        <li><strong>Тест:</strong> Установите курсор в поле "Поле для сканирования" и отсканируйте любой DataMatrix код с товара.</li>
                        <li><strong>Анализ:</strong>
                            <ul>
                                <li><strong class="text-success">УСПЕХ:</strong> Если в таблице анализа появится строка с <strong>пробелом (Char Code 32)</strong>. Это стандартное и ожидаемое поведение для веб-приложений. Система на сервере автоматически преобразует его обратно в GS.</li>
                                <li><strong class="text-primary">ИДЕАЛЬНО:</strong> Если в таблице появится строка с <strong>GS (Char Code 29)</strong>. Это означает, что ваш браузер не заменяет символ, что тоже хорошо.</li>
                                <li><strong class="text-danger">ПРОБЛЕМА:</strong> Если в отсканированном коде на месте разделителя <strong>нет ни пробела, ни символа GS</strong> (т.е. части кода слиплись). Это означает, что браузер полностью вырезает символ, что может помешать работе.</li>
                            </ul>
                        </li>
                    </ol>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body">
                    <form id="scan-form" onsubmit="return false;">
                        <div class="mb-3">
                            <label for="scan-input" class="form-label"><strong>Поле для сканирования</strong></label>
                            <input type="text" id="scan-input" class="form-control form-control-lg" placeholder="Ожидание сканирования..." autocomplete="off" autofocus>
                        </div>
                    </form>

                    <div id="result-container" class="d-none">
                        <hr>
                        <div id="status-message"></div>
                        <div class="mt-3">
                            <h6>Сырая строка (Raw String):</h6>
                            <pre><code id="raw-string-output" class="text-break"></code></pre>
                        </div>
                        <div class="mt-3">
                            <h6>Посимвольный анализ:</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered table-sm" id="char-analysis-table">
                                    <thead>
                                        <tr>
                                            <th>Символ</th>
                                            <th>Char Code (Dec)</th>
                                            <th>Примечание</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Сюда будут добавлены строки с анализом -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Новый блок для отладки -->
            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Журнал событий клавиатуры (Live Debug Log)</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        Если тест по-прежнему не проходит, пожалуйста, отсканируйте код и скопируйте весь текст из поля ниже.
                        Это поможет разработчику точно определить, какие сигналы отправляет сканер.
                    </p>
                    <pre id="debug-log" style="height: 200px; overflow-y: scroll; border: 1px solid #ccc; background: #f8f9fa; padding: 10px; font-size: 0.8rem;"></pre>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Настройка сканера Zebra</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Если тест не пройден, последовательно отсканируйте эти управляющие штрихкоды из официального руководства.</p>
                    
                    <div class="barcode-instruction mb-3 text-center">
                        <h6>1. Сброс к заводским настройкам</h6>
                        <p><small>Возвращает сканер в исходное состояние.</small></p>
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAA8CAYAAACqQSPAAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAIyklEQVR42u2de2xV1R3HP/fcc+89l7aXltJWekFaaVtLpYJpY5SgI6BRxGCMiTEaY4xJjDExxhj/YkyiSXzR+EOMiTExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRx
                    </div>

                    <div class="barcode-instruction mb-3 text-center">
                        <h6>2. Добавить суффикс "Enter"</h6>
                        <p><small>Сканер будет автоматически нажимать Enter после каждого сканирования. Это необходимо для работы с веб-формами.</small></p>
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAA8CAYAAACqQSPAAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAIyklEQVR42u2de2xV1R3HP/fcc+89l7aXltJWekFaaVtLpYJpY5SgI6BRxGCMiTEaY4xJjDExxhj/YkyiSXzR+EOMiTExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxhj/YkyiSYyJ0aBRxGCMiTEaY4xJjDExxh" alt="Barcode for Add CR Suffix">
                    </div>
                    
                    <p class="mt-3"><strong>Важно:</strong> Обычно этих двух шагов достаточно. Замена символа `GS` на пробел — это редкая конфигурация. Если проблема осталась, обратитесь к полному руководству по вашему сканеру (Product Reference Guide).</p>
                    <a href="https://www.zebra.com/us/en/support-downloads/scanners/general-purpose-scanners/ds2200-series.html" target="_blank" class="btn btn-outline-secondary btn-sm w-100">
                        Документация Zebra DS2200
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const scanInput = document.getElementById('scan-input');
    const resultContainer = document.getElementById('result-container');
    const statusMessage = document.getElementById('status-message');
    const rawStringOutput = document.getElementById('raw-string-output');
    const analysisTableBody = document.querySelector('#char-analysis-table tbody');
    const debugLog = document.getElementById('debug-log');

    // Фокусируемся на поле ввода
    scanInput.focus();
    document.body.addEventListener('click', function(e) {
        // Цель: всегда держать фокус на поле ввода для сканера,
        // НО позволять пользователю взаимодействовать с важными элементами:
        // ссылками, кнопками и, что важно, областями, откуда нужно копировать текст.
        const isInteractive = e.target.closest('a, button, #result-container, #debug-log');

        if (!isInteractive) {
            scanInput.focus();
        }
    });
    // Агрессивный обработчик 'blur' удален, так как он мешал выделению текста в логах.
    // --- НОВАЯ, БОЛЕЕ НАДЕЖНАЯ ЛОГИКА ОБРАБОТКИ ВВОДА ---
    // Проблема: Некоторые браузеры полностью вырезают управляющие символы (типа GS)
    // из значения input.value. Предыдущий метод, читающий input.value по событию submit,
    // никогда не видел этот символ.
    // Решение: Мы слушаем события нажатия клавиш (keydown) и собираем свой собственный
    // "чистый" буфер данных. Это позволяет нам перехватить символ GS (event.key === 'GroupSeparator')
    // до того, как браузер его удалит. Анализ будет проводиться по нашему буферу, а не по input.value.

    let scanBuffer = '';
    // --- НОВАЯ ЛОГИКА ДЛЯ ALT-NUMPAD ---
    // Флаг, что мы находимся в процессе ввода Alt-кода (например, Alt + 0029)
    let isAltSequence = false;
    // Буфер для цифр, вводимых при зажатом Alt
    let altCodeBuffer = '';

    scanInput.addEventListener('keydown', function(event) {
        // --- ДИАГНОСТИКА: Логируем каждое нажатие, чтобы понять, что видит браузер ---
        const logMessage = `KEYDOWN -> Key: "${event.key}", Code: "${event.code}", KeyCode: ${event.keyCode}\n`;
        // Используем textContent, чтобы избежать проблем с HTML-инъекцией
        debugLog.textContent += logMessage;
        // Автоматическая прокрутка вниз
        debugLog.scrollTop = debugLog.scrollHeight;
        // --- КОНЕЦ ДИАГНОСТИКИ ---

        // 1. Завершение сканирования по Enter
        if (event.key === 'Enter') {
            event.preventDefault(); // Предотвращаем отправку формы
            if (scanBuffer) {
                analyzeCode(scanBuffer);
                scanBuffer = ''; // Очищаем наш буфер
                isAltSequence = false; // Сбрасываем все состояния
                altCodeBuffer = '';
                scanInput.value = ''; // Очищаем видимое поле
            }
            return;
        }

        // 2. Обработка последовательности Alt-Numpad
        // Начало последовательности (нажатие Alt)
        if (event.key === 'Alt' && !isAltSequence) {
            isAltSequence = true;
            altCodeBuffer = '';
            event.preventDefault();
            return;
        }

        // Сбор цифр во время удержания Alt
        if (isAltSequence && event.code.startsWith('Numpad')) {
            altCodeBuffer += event.key;
            event.preventDefault();
            return;
        }

        // Если пришла не цифра во время Alt-последовательности, сбрасываем
        if (isAltSequence) {
            // Это означает, что была нажата какая-то другая клавиша,
            // прерывающая последовательность Alt-Numpad.
            isAltSequence = false;
            altCodeBuffer = '';
        }

        // 3. Обработка обычных символов и обратная совместимость
        // Этот блок сработает, только если мы НЕ в середине Alt-последовательности.

        // Прямой перехват GS (если сканер настроен иначе)
        if (event.key === 'GroupSeparator' || event.keyCode === 29) { // keyCode 29 - это GS
            event.preventDefault(); // Не даем браузеру обработать его (и, возможно, вырезать)
            scanBuffer += '\x1d'; // Добавляем настоящий символ GS (код 29) в наш буфер
        } else if (event.key.length === 1) {
            // Это обычный печатный символ (буква, цифра, знак)
            scanBuffer += event.key;
        }
        // Другие управляющие клавиши (Shift, Alt, F5 и т.д.) будут проигнорированы
    });

    scanInput.addEventListener('keyup', function(event) {
        // --- ДИАГНОСТИКА ---
        const logMessage = `KEYUP   -> Key: "${event.key}", Code: "${event.code}", KeyCode: ${event.keyCode}\n`;
        debugLog.textContent += logMessage;
        debugLog.scrollTop = debugLog.scrollHeight;
        // --- КОНЕЦ ДИАГНОСТИКИ ---

        // Завершение последовательности Alt-Numpad (отпускание Alt)
        if (event.key === 'Alt' && isAltSequence) {
            isAltSequence = false;
            if (altCodeBuffer) {
                try {
                    const charCode = parseInt(altCodeBuffer, 10);
                    if (!isNaN(charCode) && charCode > 0) {
                        scanBuffer += String.fromCharCode(charCode);
                    }
                } catch (e) { /* Игнорируем ошибки парсинга */ }
            }
            altCodeBuffer = '';
            event.preventDefault();
        }
    });

    function analyzeCode(code) {
        resultContainer.classList.remove('d-none');
        rawStringOutput.textContent = code;
        analysisTableBody.innerHTML = ''; // Очищаем таблицу

        let gsFound = false;
        let spaceFound = false;
        const GS_CHAR_CODE = 29;

        for (let i = 0; i < code.length; i++) {
            const char = code[i];
            const charCode = code.charCodeAt(i);
            
            const row = analysisTableBody.insertRow();
            const cellChar = row.insertCell();
            const cellCode = row.insertCell();
            const cellNote = row.insertCell();

            // Для непечатаемых символов показываем их код
            if (charCode < 32 && charCode !== 9 && charCode !== 10 && charCode !== 13) {
                 cellChar.textContent = `[${charCode}]`;
            } else {
                 cellChar.textContent = char;
            }
           
            cellCode.textContent = charCode;
            
            let note = '';
            if (charCode === GS_CHAR_CODE) {
                note = 'Символ-разделитель GS!';
                gsFound = true;
                row.classList.add('gs-found', 'table-success');
            } else if (char === ' ') {
                note = 'Пробел (вероятная замена GS)';
                spaceFound = true;
                row.classList.add('table-info');
            } else if (charCode < 32 && charCode !== 9 && charCode !== 10 && charCode !== 13) {
                note = 'Непечатаемый управляющий символ';
            }

            cellNote.textContent = note;
        }

        if (gsFound) {
            statusMessage.innerHTML = `
                <div class="alert alert-success">
                    <strong>ИДЕАЛЬНЫЙ РЕЗУЛЬТАТ!</strong> Символ-разделитель GS (Char Code 29) успешно обнаружен. Ваш сканер и браузер передают код без изменений.
                </div>
            `;
        } else if (spaceFound) {
            statusMessage.innerHTML = `
                <div class="alert alert-success">
                    <strong>УСПЕХ!</strong> Обнаружен пробел (Char Code 32). Это <strong>нормальное и ожидаемое поведение</strong> в большинстве браузеров, которые заменяют невидимый символ GS на пробел. Система настроена на обработку такой замены.
                </div>
            `;
        } else {
            statusMessage.innerHTML = `
                <div class="alert alert-danger">
                    <strong>ПРОВЕРКА НЕ ПРОЙДЕНА.</strong> В коде не обнаружен ни символ-разделитель GS (код 29), ни пробел на его месте.
                    <br>
                    Это означает, что браузер может полностью вырезать управляющий символ. Работа системы не гарантируется. Попробуйте использовать другой браузер или обратитесь к администратору.
                </div>
            `;
        }
    }
});
</script>
{% endblock %}