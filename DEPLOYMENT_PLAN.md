# План развертывания и обновления продуктового сервера

Этот документ описывает пошаговую процедуру безопасного обновления продуктового сервера, включая создание резервной копии данных, слияние веток в Git и развертывание изменений.

**Цель:** Обновить приложение на продуктовом сервере, внедрив функционал из ветки разработки (например, с поддержкой SSL для PostgreSQL), не потеряв при этом существующие данные.

---

## Шаг 1: Подготовка и Резервное копирование (на продуктовом сервере)

**Никогда не пропускайте этот шаг!**

1.  **Подключитесь к продуктовому серверу** по SSH.

2.  **Определите имя Docker-контейнера** с базой данных PostgreSQL. Обычно его можно найти, выполнив команду:

    ```bash
    docker ps
    ```
    Найдите в списке контейнер с образом `postgres` и запомните его имя (например, `app-portal-db-1`).

3.  **Создайте резервную копию базы данных.** Выполните следующую команду, подставив свои значения:

    *   `[имя_контейнера_бд]` — имя вашего Docker-контейнера с PostgreSQL.
    *   `[имя_пользователя_бд]` — имя пользователя для подключения к БД (из `.env` файла).

    ```bash
    # Команда создаст файл .sql с полной резервной копией базы данных
    docker exec -t [имя_контейнера_бд] pg_dumpall -c -U [имя_пользователя_бд] > dump_$(date +%Y-%m-%d_%H-%M-%S).sql
    ```

    **Пример:**
    ```bash
    docker exec -t app-portal-db-1 pg_dumpall -c -U postgres > dump_2025-11-01_15-30-00.sql
    ```

4.  **Проверьте, что бэкап создан.** Убедитесь, что в текущей папке появился `.sql` файл ненулевого размера. Сохраните его в надежном месте.

---

## Шаг 2: Слияние веток в Git (на вашем локальном компьютере)

Этот шаг объединяет код из ветки разработки в основную ветку `main`.

1.  **Переключитесь на вашу ветку разработки** (например, `feature-development`) и убедитесь, что все последние изменения закоммичены и отправлены на сервер.

    ```bash
    git checkout feature-development
    git pull origin feature-development
    ```

2.  **Обновите ветку разработки** последними изменениями из `main`. Это поможет выявить конфликты на вашей стороне, а не в `main`.

    ```bash
    git pull origin main
    ```
    *Если возникнут конфликты, решите их, сделайте коммит и отправьте изменения (`git push`).*

3.  **Переключитесь на основную ветку `main`** и загрузите последние изменения.

    ```bash
    git checkout main
    git pull origin main
    ```

4.  **Выполните слияние** ветки разработки в `main`.

    ```bash
    git merge feature-development
    ```

5.  **Отправьте обновленную ветку `main`** на удаленный сервер.

    ```bash
    git push origin main
    ```

Теперь в ветке `main` находится актуальный код, готовый к развертыванию.

---

## Шаг 3: Обновление продуктового сервера

1.  **Подключитесь к продуктовому серверу** по SSH и перейдите в папку проекта.

2.  **Обновите код из Git**, загрузив последние изменения из ветки `main`.

    ```bash
    git checkout main
    git pull origin main
    ```

3.  **Обновите `.env` файл.** Добавьте в него новые переменные, необходимые для подключения к PostgreSQL по SSL. Путь к сертификату должен быть абсолютным внутри контейнера.

    ```env
    # ... существующие переменные ...

    # Новые переменные для подключения к БД с SSL
    DB_SSL_MODE=verify-full
    DB_SSL_ROOTCERT=/path/in/container/to/server.crt
    ```

4.  **Пересоберите и перезапустите Docker-контейнеры**, чтобы применить изменения в коде и конфигурации.

    ```bash
    docker-compose up --build -d
    ```

5.  **Проверьте логи** приложения, чтобы убедиться, что оно успешно запустилось и подключилось к базе данных.

    ```bash
    # Показать логи всех сервисов
    docker-compose logs -f

    # Показать логи конкретного приложения
    docker-compose logs -f dmkod-integration-app
    ```

После выполнения этих шагов ваш продуктовый сервер будет обновлен, а данные останутся в целости и сохранности.